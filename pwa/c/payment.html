<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment | Kukaya Apartments</title>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    padding: 30px;
    background: #f5f7fa;
    display: flex;
    justify-content: center;
  }

  .container {
    width: 100%;
    max-width: 420px;
    background: #fff;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  h2 {
    text-align: center;
    color: #0033a0;
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-weight: 500;
    margin-top: 12px;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
  }

  .mobile-options {
    margin-top: 8px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fafafa;
    display: none;
  }

  .mobile-options label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: normal;
    margin-top: 6px;
  }

  button {
    margin-top: 25px;
    width: 100%;
    padding: 12px;
    font-size: 16px;
    background: #0033a0;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
  }

  button:hover {
    background: #00267a;
  }

  .amount {
    font-weight: bold;
    color: #333;
  }
</style>
</head>
<body>

<div class="container">
  <h2>Complete Your Payment</h2>
  <p><strong>Phone:</strong> <span id="user-phone"></span></p>

  <form id="payment-form">
    <label>Payment Method:</label>
    <select id="payment-method" required title="Select a payment method">
      <option value="">Select method</option>
      <option value="Mobile">Mobile Payment</option>
      <option value="Bank">Bank Transfer</option>
    </select>

    <!-- Mobile Payment Options -->
    <div id="mobile-options" class="mobile-options">
      <label><input type="radio" name="mobile-operator" value="Mpesa"> M-Pesa</label>
      <label><input type="radio" name="mobile-operator" value="TigoPesa"> Tigo Pesa</label>
      <label><input type="radio" name="mobile-operator" value="AirtelMoney"> Airtel Money</label>
      <label><input type="radio" name="mobile-operator" value="Halopesa"> HaloPesa</label>
    </div>

    <!-- Bank Options -->
    <div id="bank-options" class="mobile-options">
      <label>Choose Bank:</label>
      <select id="bank-name">
        <option value="">Select your bank</option>
        <option value="NMB">NMB Bank</option>
        <option value="CRDB">CRDB Bank</option>
        <option value="NBC">NBC Bank</option>
      </select>
    </div>

    <label>Total Amount (TZS):</label>
    <input type="number" id="payment-amount" readonly class="amount" title="Payment Amount" placeholder="Enter amount" />

    <button type="submit">Finish Booking & Pay</button>
  </form>
</div>

<script>
const API_BASE = `http://${window.location.hostname}:8000/api`;
const bookingData = JSON.parse(sessionStorage.getItem('pendingBooking') || '{}');
const userPhone = sessionStorage.getItem('userPhone') || 'N/A';
document.getElementById('user-phone').textContent = userPhone;

// Auto-calculate amount
function calculateTotal() {
  const price = parseFloat(bookingData.price_per_night || bookingData.cost || 0);
  const days = parseInt(bookingData.days || bookingData.nights || 1);
  const total = price * days;
  document.getElementById('payment-amount').value = total.toFixed(2);
}
calculateTotal();

// Payment method change handler
const methodSelect = document.getElementById('payment-method');
methodSelect.addEventListener('change', () => {
  document.getElementById('mobile-options').style.display =
    methodSelect.value === 'Mobile' ? 'block' : 'none';
  document.getElementById('bank-options').style.display =
    methodSelect.value === 'Bank' ? 'block' : 'none';
});

// CSRF helper
function getCookie(name) {
  const cookies = document.cookie ? document.cookie.split('; ') : [];
  for (const c of cookies) {
    const [k, ...v] = c.split('=');
    if (k === name) return decodeURIComponent(v.join('='));
  }
  return null;
}

async function apiFetch(path, opts={}) {
  const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
  const headers = new Headers(opts.headers || {});
  headers.set('Accept','application/json');
  if (opts.body && !(opts.body instanceof FormData)) headers.set('Content-Type','application/json');
  const csrftoken = getCookie('csrftoken');
  if (csrftoken) headers.set('X-CSRFToken', csrftoken);
  const res = await fetch(url, {...opts, headers, credentials:'include'});
  const text = await res.text();
  try { return JSON.parse(text||'{}'); } catch { return {ok:false,error:text}; }
}

document.getElementById('payment-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const method = document.getElementById('payment-method').value;
  let provider = null;

  if (method === 'Mobile') {
    const checked = document.querySelector('input[name="mobile-operator"]:checked');
    if (!checked) return alert('Please select a mobile operator');
    provider = checked.value;
  } else if (method === 'Bank') {
    const bank = document.getElementById('bank-name').value;
    if (!bank) return alert('Please select a bank');
    provider = bank;
  } else {
    return alert('Select a payment method');
  }

  const amount = parseFloat(document.getElementById('payment-amount').value);

  const payload = {
    booking: bookingData,
    payment: { method, provider, amount }
  };

  const res = await apiFetch('/bookings/complete-payment/', {
    method: 'POST',
    body: JSON.stringify(payload)
  });

  if (res && res.ok) {
    alert('Booking and payment successful!');
    sessionStorage.removeItem('pendingBooking');
    window.location.href = 'dashboard.html';
  } else {
    alert(res.error || 'Payment failed.');
  }
});
</script>
</body>
</html>
