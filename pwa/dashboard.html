<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kukaya Apartments ‚Äî Dashboard</title>
<link rel="shortcut icon" href="./assets/icons/icon-192.jpg" type="image/x-icon">
<link rel="manifest" href="../manifest.json">
<style>
/* =================== Reset =================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
body { background-color: #f8f9fa; color: #333; padding-bottom: 80px; }

/* =================== Header =================== */
header {
  background-color: #0033a0; color: white; padding: 12px 16px;
  display: flex; justify-content: space-between; align-items: center;
  position: sticky; top: 0; z-index: 10;
}
header h1 { font-size: 18px; }
header .icon-btn { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }

/* =================== Search Bar =================== */
.search-bar { padding: 10px 16px; background: #fff; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid #ddd; }
.search-bar input { flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; outline: none; }
.search-bar button { background: #0033a0; border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; }

/* =================== Categories Bar =================== */
.categories-bar { display: flex; justify-content: space-around; background: #fff; padding: 10px 0; border-bottom: 1px solid #ddd; }
.category-btn { background: #f1f1f1; border: none; border-radius: 20px; padding: 8px 14px; font-size: 14px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: background 0.2s, color 0.2s; }
.category-btn.active, .category-btn:hover { background: #0033a0; color: white; }

/* =================== Sections =================== */
main { padding: 10px 16px; }
section { display: none; }
section.active { display: block; }

/* =================== Apartment Cards =================== */
.apartments-list { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
.apartment-card { background: white; border-radius: 10px; padding: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.apartment-card:hover { transform: translateY(-3px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.apartment-card img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
.apartment-card h3 { font-size: 16px; margin-bottom: 4px; }
.apartment-card p { font-size: 14px; margin-bottom: 4px; }

/* =================== Modal =================== */
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
.modal.active, .modal.show { display: flex; }
.modal-content { background: white; border-radius: 10px; padding: 16px; width: 90%; max-height: 90%; overflow-y: auto; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* =================== Image Slider =================== */
.slider { position: relative; width: 100%; overflow: hidden; border-radius: 8px; margin-bottom: 10px; }
.slides { display: flex; transition: transform 0.4s ease-in-out; }
.slides img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; }
.arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
.arrow.left { left: 8px; }
.arrow.right { right: 8px; }
.dots { text-align: center; margin-top: 6px; }
.dot { height: 8px; width: 8px; margin: 0 4px; background-color: #bbb; border-radius: 50%; display: inline-block; transition: background-color 0.3s; }
.dot.active { background-color: #0033a0; }

.modal h3 { font-size: 18px; margin-bottom: 6px; color: #0033a0; }
.modal p { font-size: 14px; margin-bottom: 8px; }
.modal-buttons { display: flex; gap: 8px; margin-top: 10px; }
.modal-buttons button { flex: 1; border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-size: 14px; }
.btn-close { background: #ccc; color: black; }
.btn-book { background: #0033a0; color: white; }

/* =================== Booking Modal =================== */
#booking-modal .modal-content form label { display: block; font-size: 14px; margin-bottom: 4px; color: #0033a0; }
#booking-modal .modal-content form input,
#booking-modal .modal-content form textarea {
  width: 100%; padding: 8px; margin-bottom: 10px;
  border: 1px solid #ccc; border-radius: 6px;
}

/* =================== Bookings & Account =================== */
.booking-card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
.booking-card p { font-size: 14px; margin-bottom: 4px; }
.account-section p { font-size: 14px; margin-bottom: 6px; }
.logout-btn { background: #d9534f; color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; margin-top: 10px; cursor: pointer; }

/* =================== Bottom Navigation =================== */
.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -1px 6px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 8px 0; z-index: 10; }
.bottom-nav button { background: none; border: none; display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #555; cursor: pointer; }
.bottom-nav button.active { color: #0033a0; }
.bottom-nav button span { font-size: 20px; margin-bottom: 2px; }
.no-data { text-align: center; margin-top: 20px; color: #666; font-size: 14px; }

/* =================== Booking Form   ==================== */

/* Modal base override - already defined earlier but add icons and rooms control */
.input-icon { position: relative; }
.input-icon input[type="date"] { padding-right: 42px; }
.input-icon .icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: auto; /* make clickable on small screens */
  font-size: 1.12rem;
  opacity: 0.85;
  background: rgba(255,255,255,0.95);
  border-radius: 6px;
  padding: 4px;
}

/* Rooms control */
.rooms-control {
  display: flex;
  align-items: center;
  gap: 8px;
}
.rooms-control input {
  appearance: none;
}
.rooms-control button {
  background: #0033a0;
  color: white;
  border: none;
  font-size: 1.2rem;
  width: 40px;
  height: 40px;
  border-radius: 6px;
  cursor: pointer;
}

/* smaller screen tweaks */
@media (max-width: 480px) {
  .modal-content { width: 95%; padding: 16px; }
  .input-icon .icon { right: 8px; }
  .rooms-control button { width: 36px; height: 36px; }
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <h1>Kukaya Apartments</h1>
  <button class="icon-btn" type="button" aria-label="Notifications">üîî</button>
</header>

<!-- Search -->
<div class="search-bar">
  <input type="text" id="search-input" placeholder="Search apartments..." oninput="filterAndRenderApartments()">
  <button onclick="filterAndRenderApartments()">üîç</button>
</div>

<!-- Categories -->
<div class="categories-bar">
  <button class="category-btn active" data-type="all">üè† All</button>
  <button class="category-btn" data-type="apartment">üè† Apartment</button>
  <button class="category-btn" data-type="hotel">üè® Hotel</button>
  <button class="category-btn" data-type="office">üè¢ Office</button>
</div>

<!-- Sections -->
<main>
  <section id="home-section" class="active">
    <h2>Available Apartments</h2>
    <div id="owner-apartments" class="apartments-list"></div>
  </section>

  <section id="bookings-section">
    <h2>Bookings</h2>
    <div id="bookings-list"></div>
  </section>

  <section id="account-section">
    <h2>Account</h2>
    <div class="account-section">
      <!-- <p><strong>Phone:</strong> <span id="account-phone"></span></p>
      <p><strong>Role:</strong> <span id="account-role"></span></p> -->
      <button class="logout-btn" type="button" onclick="window.location.href='./login.html'">Singin</button>
    </div>
  </section>
</main>

<!-- Apartment Modal -->
<div class="modal" id="apartment-modal" role="dialog" aria-modal="true">
  <div class="modal-content" id="modal-content"></div>
</div>

<!-- Booking Modal -->
<div class="modal" id="booking-modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <h3>Book Apartment</h3>
    <form id="booking-form" onsubmit="submitBooking(event)">
      <input type="hidden" id="booking-apartment-id" />

      <label for="checkin">Check-in Date:</label>
      <div class="input-icon">
        <input type="date" id="checkin" required />
      </div>

      <label for="checkout">Check-out Date:</label>
      <div class="input-icon">
        <input type="date" id="checkout" required />
      </div>

      <label for="rooms">Number of Rooms:</label>
      <div class="rooms-control">
        <input type="number" id="rooms" min="1" value="1" placeholder="Any number" />
        <button type="button" id="add-room">+</button>
      </div>

      <label for="notes">Additional Notes:</label>
      <textarea id="notes" placeholder="Write any notes (option)..."></textarea>

      <div class="modal-buttons">
        <button type="submit" class="btn-book">Submit Booking</button>
        <button type="button" class="btn-close" onclick="closeBookingForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <button class="active" onclick="showSection('home', event)"><span>üè†</span>Home</button>
  <button onclick="showSection('bookings', event)"><span>üìÑ</span>Bookings</button>
  <button onclick="showSection('account', event)"><span>üë§</span>Account</button>
</div>

<script>
/* Utility & Security Helpers */

const API_BASE = `http://${window.location.hostname}:8000/api`;

/* Read cookie value safely */
function getCookie(name) {
  const cookies = document.cookie ? document.cookie.split('; ') : [];
  for (const c of cookies) {
    const [k, ...v] = c.split('=');
    if (k === name) return decodeURIComponent(v.join('='));
  }
  return null;
}

/*
 * Centralized fetch wrapper:
 * - includes credentials
 * - adds X-CSRFToken header if available
 * - handles 401 by redirecting to login
 */
async function apiFetch(path, opts = {}) {
  const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
  const headers = new Headers(opts.headers || {});
  headers.set('Accept', 'application/json');
  if (opts.body && !(opts.body instanceof FormData)) {
    headers.set('Content-Type', 'application/json');
  }

  const csrftoken = getCookie('csrftoken');
  if (csrftoken) headers.set('X-CSRFToken', csrftoken);

  const res = await fetch(url, {
    ...opts,
    headers,
    credentials: 'include',
  });

  if (res.status === 401) {
    alert('Session expired or not authenticated. Please login.');
    window.location.href = '../index.html';
    return null;
  }

  // try parse as json, but gracefully handle non-json
  const text = await res.text();
  try {
    return JSON.parse(text || '{}');
  } catch (err) {
    return { ok: false, error: 'Invalid JSON response', raw: text };
  }
}


function escapeHTML(str = '') {
  return String(str).replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

/* Auth check & init */

let apartmentsData = [];
let currentSlide = 0;
let selectedCategory = 'all';
let currentUser = null;

/* Section navigation */
function showSection(section, event) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(`${section}-section`).classList.add('active');
  document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
  if (event) event.currentTarget.classList.add('active');
}

/* Apartments loading & rendering */

async function loadApartments(category='all') {
  try {
    const res = await apiFetch('/apartments/lists');
    if (!res || !res.ok) {
      document.getElementById('owner-apartments').innerHTML = `<p class="no-data">Failed to load apartments.</p>`;
      apartmentsData = [];
      return;
    }
    apartmentsData = res.apartments || [];
    filterAndRenderApartments();
  } catch (err) {
    console.error(err);
    document.getElementById('owner-apartments').innerHTML = `<p class="no-data">Failed to load apartments.</p>`;
  }
}

function renderApartments(list) {
  const container = document.getElementById('owner-apartments');
  if (!list || list.length === 0) {
    container.innerHTML = `<p class="no-data">No apartments found.</p>`;
    return;
  }

  // Build cards but insert text safely
  container.innerHTML = '';
  list.forEach(a => {
    const card = document.createElement('div');
    card.className = 'apartment-card';
    card.tabIndex = 0;
    // store id on dataset
    card.dataset.apartmentId = a.id;

    const img = document.createElement('img');
    img.alt = a.name ? String(a.name) : 'Apartment';
    img.src = (a.images && a.images.length) ? a.images[0].image_url : 'assets/images/no-image.jpg';
    card.appendChild(img);

    const h3 = document.createElement('h3');
    h3.textContent = a.name || 'Unnamed';
    card.appendChild(h3);

    const loc = document.createElement('p');
    loc.innerHTML = `<strong>Location:</strong> ${escapeHTML(a.location || '')}`;
    card.appendChild(loc);

    const price = document.createElement('p');
    price.innerHTML = `<strong>Price:</strong> Tzs. ${escapeHTML(a.price || '')}/=`;
    card.appendChild(price);

    const cat = document.createElement('p');
    cat.innerHTML = `<strong>Type:</strong> ${escapeHTML(a.category || '')}`;
    card.appendChild(cat);

    card.addEventListener('click', () => openApartmentModal(a.id));
    container.appendChild(card);
  });
}

function filterAndRenderApartments() {
  const query = (document.getElementById('search-input').value || '').toLowerCase();
  const filtered = apartmentsData.filter(a => {
    const matchesCategory = selectedCategory === 'all' || (a.category || '').toLowerCase() === selectedCategory.toLowerCase();
    const matchesSearch = (a.name || '').toLowerCase().includes(query) || (a.location || '').toLowerCase().includes(query);
    return matchesCategory && matchesSearch;
  });
  renderApartments(filtered);
}

/* Category buttons */
document.querySelectorAll('.category-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedCategory = btn.dataset.type;
    loadApartments(selectedCategory);
  });
});

/* Apartment Modal + slider */

function openApartmentModal(id) {
  const apt = apartmentsData.find(a => a.id === id);
  if (!apt) return;
  const modal = document.getElementById('apartment-modal');
  const modalContent = document.getElementById('modal-content');

  const images = apt.images && apt.images.length ? apt.images : [{image_url: 'assets/images/no-image.jpg'}];
  const slidesHTML = images.map(img => `<img src="${escapeHTML(img.image_url)}" alt="${escapeHTML(apt.name || '')}">`).join('');
  const dotsHTML = images.map((_, i) => `<span class="dot ${i===0? 'active' : ''}" data-index="${i}"></span>`).join('');
  const offersHTML = apt.offers && apt.offers.length ? `<p><strong>Offers:</strong> ${escapeHTML(apt.offers.join(', '))}</p>` : '';

  // Use textContent for sensitive fields elsewhere, but building modal innerHTML for complex layout is acceptable since we escape values.
  modalContent.innerHTML = `
    <div class="slider">
      <div class="slides">${slidesHTML}</div>
      <button class="arrow left" onclick="moveSlide(-1)">‚ùÆ</button>
      <button class="arrow right" onclick="moveSlide(1)">‚ùØ</button>
      <div class="dots">${dotsHTML}</div>
    </div>
    <h3>${escapeHTML(apt.name || '')}</h3>
    <p><strong>Location:</strong> ${escapeHTML(apt.location || '')}</p>
    <p><strong>Price:</strong> Tzs. ${escapeHTML(apt.price || '')}/= /Night</p>
    <p>${escapeHTML(apt.details || 'No estimate distance')}</p>
    ${offersHTML}
    <div class="modal-buttons">
      <button class="btn-book" onclick="bookApartment(${apt.id})">Reserve</button>
      <button class="btn-book" onclick="chatApartment(${apt.id})">Chat</button>
      <button class="btn-close" onclick="closeModal()">Close</button>
    </div>
  `;

  currentSlide = 0;
  modal.classList.add('active');
  showSlide();
}

function moveSlide(step) {
  const slides = document.querySelectorAll('.slides img');
  if (!slides.length) return;
  currentSlide = (currentSlide + step + slides.length) % slides.length;
  showSlide();
}

function showSlide() {
  const slides = document.querySelector('.slides');
  const dots = document.querySelectorAll('.dot');
  if (!slides) return;
  slides.style.transform = `translateX(-${currentSlide * 100}%)`;
  dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
}

function closeModal() {
  document.getElementById('apartment-modal').classList.remove('active');
}

/* Booking Flow */

function bookApartment(id) {
  if (!currentUser) {
    // Guest: redirect to login
    alert('You must be logged in to reserve an apartment.');
    window.location.href = './login.html';
    return;
  }

  // Authenticated: proceed with booking
  closeModal();
  openBookingForm(id);
}


function openBookingForm(id) {
  document.getElementById('booking-modal').classList.add('show');
  document.getElementById('booking-apartment-id').value = id;
  // reset form safely
  document.getElementById('booking-form').reset();
  document.getElementById('rooms').value = '1';
}

function closeBookingForm() {
  document.getElementById('booking-modal').classList.remove('show');
  document.getElementById('booking-form').reset();
}

/* focus date on icon click */
function focusDate(id) {
  const el = document.getElementById(id);
  if (el) el.focus();
}

/* increment rooms */
document.getElementById('add-room').addEventListener('click', () => {
  const roomsInput = document.getElementById('rooms');
  const val = Math.max(1, parseInt(roomsInput.value || '1', 10));
  roomsInput.value = val + 1;
});

/* submit booking with authentication */
async function submitBooking(e) {
  e.preventDefault();
  if (!currentUser) {
    alert('You must be logged in to make a booking.');
    window.location.href = '../index.html';
    return;
  }

  const bookingData = {
    apartment: document.getElementById('booking-apartment-id').value,
    checkin: document.getElementById('checkin').value,
    checkout: document.getElementById('checkout').value,
    rooms: parseInt(document.getElementById('rooms').value || '1', 10),
    notes: document.getElementById('notes').value || ''
  };

  // Store booking temporarily in sessionStorage
  sessionStorage.setItem('pendingBooking', JSON.stringify(bookingData));

  // Redirect to payment page
  window.location.href = 'payment.html';
}


/* Bookings & Account */

async function loadBookings() {
  try {
    const res = await apiFetch('/bookings/history/');
    if (!res) return;
    const container = document.getElementById('bookings-list');
    if (!res.ok || !res.bookings || res.bookings.length === 0) {
      container.innerHTML = `<p class="no-data">No bookings found.</p>`;
      return;
    }

    container.innerHTML = '';
    res.bookings.forEach(b => {
      const card = document.createElement('div');
      card.className = 'booking-card';

      const title = document.createElement('p');
      title.innerHTML = `<strong>${escapeHTML(b.apartment_name || '')}</strong> - ${escapeHTML(b.location || '')}`;
      card.appendChild(title);

      const meta = document.createElement('p');
      meta.textContent = `Price: Tzs. ${b.price || ''} | Status: ${b.status || ''}`;
      card.appendChild(meta);

      const created = document.createElement('p');
      created.textContent = `Booked at: ${new Date(b.created_at).toLocaleString()}`;
      card.appendChild(created);

      container.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    document.getElementById('bookings-list').innerHTML = `<p class="no-data">Failed to load bookings.</p>`;
  }
}

async function checkAuth() {
  return null; 
}


// CSRF helper (if needed)
function getCSRFToken() {
  const name = "csrftoken=";
  const cookies = document.cookie.split(";").map(c => c.trim());
  for (const cookie of cookies) {
    if (cookie.startsWith(name)) return cookie.substring(name.length);
  }
  return null;
}


/* Misc: chat placeholder */
function chatApartment(id) {
  alert(`Chat feature coming soon for Apartment ID ${id}`);
}

/* Init sequence (auth first) */
(async () => {
  const user = await checkAuth();

  if (user) {
    // Authenticated: Load user-specific data
    await loadApartments(selectedCategory);
    await loadBookings();
    await loadAccount();
  } 
  else {
    // Not Authenticated:
    console.log('Guest mode: showing public apartments');

    // Show all apartments (public view)
    await loadApartments(selectedCategory, { publicView: true });

    // Show ‚ÄúNo current bookings‚Äù
    const bookingsContainer = document.getElementById('bookings-list');
    if (bookingsContainer) {
      bookingsContainer.innerHTML = `<p class="no-data">No current bookings.</p>`;
    }

    // Override loadAccount() to redirect
    window.loadAccount = () => {
      window.location.href = '/login.html';
    };
  }
})();


/* ========= end script ========= */
</script>

</body>
</html>
